<% layout('layout') -%>

    <script src="js/socket.io.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCp5FCefvQbDVIoiuvnlEBRXm7jjEHUKSM&callback=initMap">
    </script>
    <script type="text/javascript">
        //------
        // Check if have req.query
        <% if(qs.id){ %>
        var globalvar = 1;
        <% }else { %>
        var globalvar = 0;
        <% } %>
        var socket = io();
        var data_id = null;
        // create Node options
        function initfunction(node) {
            console.log(node.length);
            var select = document.getElementById("sources");
            for (var i = 0, l = node.length; i < l; i++) {
                var option = node[i];
                var el = document.createElement("option");
                el.textContent = option;
                el.value = option;
                select.appendChild(el);
            }
            <% if(qs.id){ %>
            $('#sources').val("<%=qs.id%>");
            <% } %>
        }

        //Create date options


        window.onload = function() {
                <% if(temp!='nouser') {%>
                console.log("<%=temp%>");
                document.getElementById("user").innerHTML = "<%=temp%>";
                $('#modalbox').attr('data-target', '#myModal1');
                document.getElementById("userprofile").innerHTML = "<%=temp%>" + " Profile";
                <%} else{%>
                console.log("error");
                <%}%>
                //-- create options
                var NodeID = [];
                var lat = [];
                var lng = [];
                var nodeid = [];
                var phone = [];
                var Nodeinfo;
                $.ajax({
                    type: "GET",
                    url: "/getinfo?list=1&status=1", // <-- Here
                    dataType: "json",
                    success: function(data) {
                        myVariable = data;
                        count = Object.keys(myVariable).length;
                        // console.log(count);
                        for (var i = 0; i < count; i++) {
                            NodeID.push(Number(myVariable[i].node_id));
                        }
                        initfunction(NodeID);
                        // console.log(NodeID);
                    }
                });
                //---------------------------------------
                var count;
                var co = [];
                var dust = [];
                var gas = [];
                var temp = [];
                var xaxis = [];
                var bat = [];
                var node_id = null;
                if (globalvar == 1) {
                    node_id = <%=qs.id%>;
                    console.log('this is node id', node_id);
                    globalvar = 0;
                    display();
                }
                $("#sources").on("change", function() {
                    var e = document.getElementById("sources");
                    node_id = e.options[e.selectedIndex].value;
                    var myVariable, Nodeinfo;
                    count;
                    co = [];
                    dust = [];
                    gas = [];
                    temp = [];
                    xaxis = [];
                    bat = [];
                    var lat = [];
                    var lng = [];
                    var nodeid = [];
                    var phone = [];
                    display();

                   
                });

                function removeOptions(selectbox)
                {
                    var i;
                    for(i = selectbox.options.length - 1 ; i >= 0 ; i--)
                    {
                        selectbox.remove(i);
                    }
                }

                function createDateOptions(date,co,dust,temp,gas,bat,xaxis){
                    var select = document.getElementById("date");
                    for(var i = 0, l = date.length; i < l; i++){
                        var option = date[i];
                        var el = document.createElement("option");
                        el.textContent = option;
                        el.value = option;
                        select.appendChild(el);
                    }
                }

                $("#date").on("change", function() {
                    var e = document.getElementById("date");
                    date = e.options[e.selectedIndex].value;
                    var i = 0;
                    var j;
                    var long = xaxis.length;
                    for(var t=0;t<long;t++){
                        if(xaxis[t] == date){
                            j = t;
                            break;
                        }
                    }
                    var ngay = xaxis[j].getDate();
                    var thang = xaxis[j].getMonth();
                    var co1 = [];
                    var dust1 = [];
                    var temp1 = [];
                    var gas1 = [];
                    var bat1 = [];
                    var x = [];
                    for(z=j;z<long;z++){
                        if(z==j){
                            co1.push(co[z]);
                            dust1.push(dust[z]);
                            temp1.push(temp[z]);
                            gas1.push(gas[z]);
                            x.push(xaxis[z]);
                        }
                        else{
                            if(xaxis[z].getDate() == ngay && xaxis[z].getMonth()==thang){
                                co1.push(co[z]);
                                dust1.push(dust[z]);
                                temp1.push(temp[z]);
                                gas1.push(gas[z]);
                                x.push(xaxis[z]);
                            }
                        }

                    }

                    // Drow new chart

                    $(function() {
                            $('#chart').highcharts({
                                title: {
                                    text: 'Node: ' + node_id,
                                    x: -20 //center
                                },
                                subtitle: {
                                    text: '',
                                    x: -20
                                },
                                xAxis: {
                                    categories: x
                                },
                                yAxis: {
                                    title: {
                                        text: 'Value'
                                    },
                                    plotLines: [{
                                        value: 0,
                                        width: 1,
                                        color: '#808080'
                                    }]
                                },
                                tooltip: {
                                    valueSuffix: '°C'
                                },
                                legend: {
                                    layout: 'vertical',
                                    align: 'right',
                                    verticalAlign: 'middle',
                                    borderWidth: 0
                                },
                                series: [{
                                    name: 'CO',
                                    data: co1
                                }, {
                                    name: 'TEMP',
                                    data: temp1
                                }, {
                                    name: 'DUST',
                                    data: dust1
                                }, {
                                    name: 'GAS',
                                    data: gas1
                                }, {
                                    name: 'BATTERY',
                                    data: bat1
                                }]
                            });
                        });
                    
                   
                    });
                function display() {
                    // Get node data
                    $.ajax({
                        type: "GET",
                        url: "/getdata?id=" + node_id,
                        dataType: "json",
                        success: function(data) {
                            myVariable = data;
                            count = Object.keys(myVariable).length;
                            // console.log(count);
                            data_id = myVariable[0].data_id;
                            console.log('this is dataid', myVariable[0].data_id);
                            for (var i = 0; i < count; i++) {
                                co.push(Number(myVariable[i].data.co));
                                dust.push(Number(myVariable[i].data.dust));
                                temp.push(Number(myVariable[i].data.temp));
                                gas.push(Number(myVariable[i].data.gas));
                                bat.push(Number(myVariable[i].data.bat));
                                var d = new Date(myVariable[i].time);
                                xaxis.push(d);
                            }
                            console.log(data);
                            document.getElementById("update").innerHTML = "CO: "+co[count-1] +'<br/>'
                                + "Dust: " + dust[count-1] + '<br/>'
                                + "Temp: " + temp[count-1] + '<br/>'
                                + "Gas: " + gas[count-1] + '<br/>'
                                + "Batery: " + bat[count-1] + '<br/>'
                                + "DATE: " + xaxis[count-1] + '<br/>';

                            console.log(xaxis[0]);
                            var date = [];
                            for(var i=0;i<count;i++){
                                
                                if(i==0){
                                    date.push(xaxis[i]);
                                    
                                }else{
                                    var long = date.length;
                                    var lastelement = date[long-1];
                                    var ngay = lastelement.getDate();
                                    var thang = lastelement.getMonth();
                                    if(xaxis[i].getDate()!=ngay || xaxis[i].getMonth()!=thang){
                                        date.push(xaxis[i]);
                                    }
                                }
                            }
                          
                        
                            console.log(date.length);
                            removeOptions(document.getElementById("date"));
                            createDateOptions(date,co,dust,temp,gas,bat,xaxis);
                            drowchart();
                        }
                    });
                    // Get node info
                    $.ajax({
                        type: "GET",
                        url: "/getinfo?id=" + node_id,
                        dataType: "json",
                        success: function(data) {
                            Nodeinfo = data;
                            InsertInfo(Nodeinfo.node_id, Nodeinfo.phone, Nodeinfo.location.lat, Nodeinfo.location.lng);
                            console.log(Nodeinfo.location.lat);
                            initMap(Nodeinfo.location.lat,Nodeinfo.location.lng,Nodeinfo.node_id);

                        }
                    });
                    socket.off('rdata');
                    socket.on('rdata', function(updateData) {
                        console.log(data_id, '==', updateData.new_val.data_id);
                        if (data_id === updateData.new_val.data_id) {
                            console.log('get data', updateData.new_val.data);
                            co.push(Number(updateData.new_val.data.co));
                            dust.push(Number(updateData.new_val.data.dust));
                            temp.push(Number(updateData.new_val.data.temp));
                            gas.push(Number(updateData.new_val.data.gas));
                            bat.push(Number(updateData.new_val.data.bat));
                            xaxis.push(updateData.new_val.time);
                            drowchart();
                        }
                    });

                    //create marker
                    // function initMap() {
                    //     var myLatLng = {lat: -25.363, lng: 131.044};
                    //     var map = new google.maps.Map(document.getElementById('map'), {
                    //         zoom: 4,
                    //         center: myLatLng
                    //     });
                    //     var marker = new google.maps.Marker({
                    //         position: myLatLng,
                    //         map: map,
                    //         title: 'Hello World!'
                    //     });
                    // }
                    //Display node info
                    function InsertInfo(nodeid, phone, lat, lng) {
                        document.getElementById("NodeID").innerHTML = nodeid;
                        document.getElementById("Phone").innerHTML = phone;
                        document.getElementById("Latitude").innerHTML = lat;
                        document.getElementById("Longitude").innerHTML = lng;
                    }

                    // create google map thumbnail

                    //Drawchart function
                    function drowchart() {
                        // alert(xaxis);
                        $(function() {
                            $('#chart').highcharts({
                                title: {
                                    text: 'Node: ' + node_id,
                                    x: -20 //center
                                },
                                subtitle: {
                                    text: '',
                                    x: -20
                                },
                                xAxis: {
                                    categories: xaxis
                                },
                                yAxis: {
                                    title: {
                                        text: 'Value'
                                    },
                                    plotLines: [{
                                        value: 0,
                                        width: 1,
                                        color: '#808080'
                                    }]
                                },
                                tooltip: {
                                    valueSuffix: '°C'
                                },
                                legend: {
                                    layout: 'vertical',
                                    align: 'right',
                                    verticalAlign: 'middle',
                                    borderWidth: 0
                                },
                                series: [{
                                    name: 'CO',
                                    data: co
                                }, {
                                    name: 'TEMP',
                                    data: temp
                                }, {
                                    name: 'DUST',
                                    data: dust
                                }, {
                                    name: 'GAS',
                                    data: gas
                                }, {
                                    name: 'BATTERY',
                                    data: bat
                                }]
                            });
                        });
                    }
                }
            }
            //--------------------------------------
    </script>
    <style type="text/css">
        select option {
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            text-shadow: 0 1px 0 rgba(0, 0, 0, 0.4);
        }

        select {
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            text-shadow: 0 1px 0 rgba(0, 0, 0, 0.4);
        }
    </style>

    <script src="js/highcharts.js"></script>
    <script src="js/exporting.js"></script>
    <link rel="stylesheet" href="css/styleGraph.css">
    <!--  <script type="text/javascript">
    </script> -->

    <div class="box123">
        <div class="top">
            <div class="contentleft">
                <div class="left">NodeId:</div>
                <div class="id_100">
                    <select name="sources" id="sources">
                        <option value="">Chose Node ID</option>
                    </select>
                </div>
            </div>

            <div class="contentright">
                <div class="left">Date:</div>
                <div class="id_100">
                    <select name="date" id="date">
                        <option value="">Chose Date</option>
                    </select>
                </div>
            </div>

            
        </div>

        <div class="bot" style="clear: both;">
            <div class="">
                <!-- <p style="color: red">Node Info: </p> -->
                <table class="table table-striped table-bordered table-hover table-condensed">
                    <tbody>
                        <tr>
                            <td> Node ID</td>
                            <td id="NodeID"></td>
                        </tr>
                        <tr>
                            <td> Latitude </td>
                            <td id="Latitude"></td>
                        </tr>
                        <tr>
                            <td>Longitude </td>
                            <td id="Longitude"></td>
                        </tr>
                        <tr>
                            <td>Phone Number </td>
                            <td id="Phone"></td>
                        </tr>
                        <tr>
                            <td>Lasted Update </td>
                            <td id="update"></td>
                        </tr>
                    </tbody>
                    <!-- <span id="NodeInfomation"></span> -->
                </table>
            </div>
            <div id="chart" class="bright" style="float: left;width: 900px"></div>
            <div id="map" style="float: right; width: 290px;height: 390px; margin:5px auto;"></div>
        </div>
    </div>

    <script src="js/Graph.js"></script>
    <script>

      function initMap(lat,lng,message) {
        var myLatLng = {lat: lat, lng: lng};

        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 17,
          center: myLatLng
        });

        var marker = new google.maps.Marker({
          position: myLatLng,
          map: map,
          title: 'Hello World!'
        });
        addInfoWindow(marker,message);
      }

      function addInfoWindow(marker, message) {
        

            var infoWindow = new google.maps.InfoWindow({
                content: "Node ID: " + message
                    // stastic later----------------
            });

            google.maps.event.addListener(marker, 'click', function() {
                infoWindow.open(map, marker);
            });
        }
    </script>
