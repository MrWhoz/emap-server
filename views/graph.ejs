<% layout('layout') -%>

    <script src="js/socket.io.js"></script>
    <script type="text/javascript">
        //------
        // Check if have req.query
        <% if(qs.id){ %>
        var globalvar = 1;
        <% }else { %>

        var globalvar = 0;
        <% } %>
        var socket = io();
        var data_id = null;
        // create Node options
        function initfunction(node) {
            console.log(node.length);
            var select = document.getElementById("sources");
            for (var i = 0, l = node.length; i < l; i++) {
                var option = node[i];
                var el = document.createElement("option");

                el.textContent = option;
                el.value = option;
                select.appendChild(el);
            }
            <% if(qs.id){ %>
            $('#sources').val("<%=qs.id%>");

            <% } %>
        }




        window.onload = function() {
                <% if(temp!='nouser') {%>
                console.log("<%=temp%>");
                document.getElementById("user").innerHTML = "<%=temp%>";
                $('#modalbox').attr('data-target', '#myModal1');
                document.getElementById("userprofile").innerHTML = "<%=temp%>" + " Profile";
                <%} else{%>
                console.log("error");
                <%}%>

                //-- create options

                var NodeID = [];
                var lat = [];
                var lng = [];
                var nodeid = [];
                var phone = [];
                var Nodeinfo;
                $.ajax({
                    type: "GET",
                    url: "/getinfo?list=1&status=1", // <-- Here
                    dataType: "json",
                    success: function(data) {

                        myVariable = data;
                        count = Object.keys(myVariable).length;
                        // console.log(count);
                        for (var i = 0; i < count; i++) {
                            NodeID.push(Number(myVariable[i].node_id));
                        }

                        initfunction(NodeID);
                        console.log(NodeID);
                    }

                });

                //---------------------------------------
                var count;
                var co = [];
                var dust = [];
                var gas = [];
                var temp = [];
                var xaxis = [];
                var node_id = null;
                if (globalvar == 1) {
                    node_id = <%=qs.id%>;
                    console.log('this is node id', node_id);
                    globalvar = 0;
                    display();
                }

                $("#sources").on("change", function() {
                    var e = document.getElementById("sources");
                    node_id = e.options[e.selectedIndex].value;
                    var myVariable, Nodeinfo;
                    var count;
                    var co = [];
                    var dust = [];
                    var gas = [];
                    var temp = [];
                    var xaxis = [];
                    var lat = [];
                    var lng = [];
                    var nodeid = [];
                    var phone = [];
                    display();
                });

                function display() {
                    // Get node data
                    $.ajax({
                        type: "GET",
                        url: "/getdata?id=" + node_id,
                        dataType: "json",
                        success: function(data) {
                            myVariable = data;
                            count = Object.keys(myVariable).length;
                            // console.log(count);
                            data_id = myVariable[0].data_id;
                            console.log('this is dataid',myVariable[0].data_id);
                            for (var i = 0; i < count; i++) {
                                co.push(Number(myVariable[i].data.co));
                                dust.push(Number(myVariable[i].data.dust));
                                temp.push(Number(myVariable[i].data.temp));
                                gas.push(Number(myVariable[i].data.gas));
                                xaxis.push(Number(i + 1));
                            }
                            drowchart();
                        }
                    });
                    // Get node info
                    $.ajax({
                        type: "GET",
                        url: "/getinfo?id=" + node_id,
                        dataType: "json",
                        success: function(data) {
                            Nodeinfo = data;
                            nodeid.push(Number(Nodeinfo.node_id));
                            phone.push(Number(Nodeinfo.phone));
                            lat.push(Number(Nodeinfo.location.lat));
                            lng.push(Number(Nodeinfo.location.lng));


                            InsertInfo(nodeid, phone, lat, lng);
                        }
                    });
                    socket.off('rdata');
                    socket.on('rdata', function(updateData) {
                        console.log(data_id, '==', updateData.new_val.data_id);
                        if (data_id === updateData.new_val.data_id) {
                            console.log('get data', updateData.new_val.data);

                            co.push(Number(updateData.new_val.data.co));
                            dust.push(Number(updateData.new_val.data.dust));
                            temp.push(Number(updateData.new_val.data.temp));
                            gas.push(Number(updateData.new_val.data.gas));
                            drowchart();
                        }
                    });
                    //Display node info
                    function InsertInfo(x, y, z, t) {
                        document.getElementById("NodeInfomation").innerHTML = '<i style="color:red">' + "Node_Id: " + '</i>' + x + '<br/>' +
                            '<i style="color:red">' + "Location_lat: " + '</i>' + z + '<br/>' +
                            '<i style="color:red">' + "Location_lng: " + '</i>' + t + '<br/>' +
                            '<i style="color:red">' + "Phone: " + '</i>' + y + '<br/>'
                    }
                    //Drawchart function
                    function drowchart() {
                        // alert(xaxis);
                        $(function() {

                            $('#chart').highcharts({
                                title: {
                                    text: 'Node: ' + node_id,
                                    x: -20 //center
                                },
                                subtitle: {
                                    text: '',
                                    x: -20
                                },
                                xAxis: {
                                    categories: xaxis
                                },
                                yAxis: {
                                    title: {
                                        text: 'Value'
                                    },
                                    plotLines: [{
                                        value: 0,
                                        width: 1,
                                        color: '#808080'
                                    }]
                                },
                                tooltip: {
                                    valueSuffix: 'Â°C'
                                },
                                legend: {
                                    layout: 'vertical',
                                    align: 'right',
                                    verticalAlign: 'middle',
                                    borderWidth: 0
                                },
                                series: [{
                                    name: 'CO',
                                    data: co
                                }, {
                                    name: 'TEMP',
                                    data: temp
                                }, {
                                    name: 'DUST',
                                    data: dust
                                }, {
                                    name: 'GAS',
                                    data: gas
                                }]
                            });
                        });
                    }
                }

            }
            //--------------------------------------
    </script>
    <style type="text/css">
        select option {
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            text-shadow: 0 1px 0 rgba(0, 0, 0, 0.4);
        }

        select {
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            text-shadow: 0 1px 0 rgba(0, 0, 0, 0.4);
        }
    </style>

    <script src="js/highcharts.js"></script>
    <script src="js/exporting.js"></script>
    <link rel="stylesheet" href="css/styleGraph.css">
    <!--  <script type="text/javascript">

    </script> -->


    <div class="box123">
        <div class="top">
            <div class="left">NodeId:</div>
            <div class="id_100">
                <select name="sources" id="sources">
                    <option value="">Chose Node ID</option>
                </select>
            </div>
        </div>



        <div class="bot">
            <div class="bleft">
                <!-- <p style="color: red">Node Info: </p> -->
                <span id="NodeInfomation"></span>
            </div>
            <div id="chart" class="bright"></div>
        </div>
    </div>





    <script src="js/Graph.js"></script>
    <!--  <script type="text/javascript">


    </script>
 -->
